import asyncio

from collections import deque
from aiogram import Bot, Dispatcher, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
import json

stack = deque()

bot = Bot(token="6141417763:AAE8EH-x1TLaGh_MCrK4aIXzrvvSV3PQFGc")
storage = MemoryStorage()
dp = Dispatcher(bot, storage=storage)


def save_language_choice(user_id, language):
    data = {}

    try:
        with open('language_data.json', 'r') as file:
            data = json.load(file)
    except (FileNotFoundError, json.JSONDecodeError):
        pass

    if str(user_id) in data:
        data[str(user_id)] = language
    else:
        data[str(user_id)] = language

    with open('language_data.json', 'w') as file:
        json.dump(data, file)


def check_user_exists(user_id):
    try:
        with open('language_data.json', 'r') as file:
            data = json.load(file)
            return str(user_id) in data
    except (FileNotFoundError, json.JSONDecodeError):
        return False


def get_user_language(user_id):
    try:
        with open('language_data.json', 'r') as file:
            data = json.load(file)
            return data.get(str(user_id))
    except (FileNotFoundError, json.JSONDecodeError):
        return None


@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    name = message.from_user.full_name
    user_id = message.from_user.id
    await bot.send_chat_action(user_id, 'typing')
    await asyncio.sleep(0.5)

    lang_keyboard = types.InlineKeyboardMarkup()
    lang_keyboard.add(types.InlineKeyboardButton(text="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞üá∫üá¶", callback_data="lang_ua"),
                      types.InlineKeyboardButton(text="Englishüá¨üáß", callback_data="lang_en"))

    if check_user_exists(user_id):
        await start_taryf(message)
    else:
        await message.reply(f"""–ü—Ä–∏–≤—ñ—Ç *{name}*, –±—É–¥—å–ª–∞—Å–∫–∞ –æ–±–µ—Ä–∏ –º–æ–≤—É!  
Hi *{name}*, please choose your language!""",
                            reply_markup=lang_keyboard, parse_mode="Markdown")


@dp.message_handler(commands=['language'])
async def change_lang(message: types.Message):
    user_id = message.from_user.id
    await bot.send_chat_action(user_id, 'typing')
    await asyncio.sleep(0.5)
    lang_keyboard = types.InlineKeyboardMarkup()
    lang_keyboard.add(types.InlineKeyboardButton(text="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞üá∫üá¶", callback_data="lang_ua"),
                      types.InlineKeyboardButton(text="Englishüá¨üáß", callback_data="lang_en"))

    await message.reply(f"""–ë—É–¥—å–ª–∞—Å–∫–∞ –æ–±–µ—Ä–∏ –º–æ–≤—É!  
Please choose your language!""",
                        reply_markup=lang_keyboard, parse_mode="Markdown")


async def start_taryf(message: types.Message):
    user_id = message.from_user.id
    name = message.from_user.full_name
    user_language = get_user_language(user_id)

    if user_language == "ua":
        start_keyboard_ua = types.InlineKeyboardMarkup()
        start_keyboard_ua.add(types.InlineKeyboardButton(text="üîé–ü–æ—á–∞—Ç–∏ –ø—ñ–¥–±—ñ—Ä", callback_data="age_survey"))
        await bot.send_message(user_id, f"–ü—Ä–∏–≤—ñ—Ç *{name}*! –Ø –¥–æ–ø–æ–º–æ–∂—É —Ç–æ–±—ñ –∑–Ω–∞–π—Ç–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π –¥–ª—è —Ç–µ–±–µ —Ç–∞—Ä–∏—Ñ Lifecell!",
                               reply_markup=start_keyboard_ua, parse_mode="Markdown")

    elif user_language == "en":
        start_keyboard_en = types.InlineKeyboardMarkup()
        start_keyboard_en.add(types.InlineKeyboardButton(text="üîéStart selection", callback_data="age_survey"))
        await bot.send_message(user_id, f"Hello *{name}*! I will help you to find the best Lifecell tariff!",
                               reply_markup=start_keyboard_en, parse_mode="Markdown")


@dp.callback_query_handler(lambda call: call.data == 'age_survey')
async def age_select(call: types.CallbackQuery):
    name = call.from_user.full_name
    user_id = call.from_user.id
    user_language = get_user_language(user_id)

    if user_language == "ua":
        understood_keyboard_ua = types.InlineKeyboardMarkup()
        understood_keyboard_ua.add(types.InlineKeyboardButton(text="‚úÖ–ó—Ä–æ–∑—É–º—ñ–ª–æ", callback_data="understood"))

        await call.message.edit_text(
            text=f"*{name}*, —â–æ–± –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —Ç–∞—Ä–∏—Ñ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞ –∑–∞–ø–∏—Ç–∞–Ω—å.",
            reply_markup=understood_keyboard_ua, parse_mode="Markdown")

    elif user_language == "en":
        understood_keyboard_en = types.InlineKeyboardMarkup()
        understood_keyboard_en.add(types.InlineKeyboardButton(text="‚úÖUnderstood", callback_data="understood"))

        await call.message.edit_text(
            text=f"*{name}*, to choose the best tariff, you need to answer a few simple questions.",
            reply_markup=understood_keyboard_en, parse_mode="Markdown")

    # –î–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–æ —Å—Ç–µ–∫—É
    stack.append(age_select)


@dp.callback_query_handler(lambda call: call.data == 'understood')
async def undersood_handler(call: types.CallbackQuery):
    user_id = call.from_user.id
    user_language = get_user_language(user_id)

    if user_language == "ua":
        less_than_eighteen = types.InlineKeyboardButton(text="–ú–µ–Ω—à–µ 18", callback_data="less_than_eighteen")
        more_than_eighteen = types.InlineKeyboardButton(text="–ë—ñ–ª—å—à–µ 18", callback_data="more_than_eighteen")
        back_button = types.InlineKeyboardButton(text="‚¨Ö –ù–∞–∑–∞–¥", callback_data="back")

        age_keyboard = types.InlineKeyboardMarkup()
        age_keyboard.row(less_than_eighteen, more_than_eighteen)
        age_keyboard.row(back_button)

        await call.message.edit_text(text="""*–ü–µ—Ä—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è*:
–ë—É–¥—å–ª–∞—Å–∫–∞ –æ–±–µ—Ä—ñ—Ç—å –≤–∞—à –≤—ñ–∫.""", reply_markup=age_keyboard, parse_mode="Markdown")
    elif user_language == "en":
        less_than_eighteen = types.InlineKeyboardButton(text="Less than 18", callback_data="less_than_eighteen")
        more_than_eighteen = types.InlineKeyboardButton(text="More than 18", callback_data="more_than_eighteen")
        back_button = types.InlineKeyboardButton(text="‚¨Ö Back", callback_data="back")

        age_keyboard = types.InlineKeyboardMarkup()
        age_keyboard.row(less_than_eighteen, more_than_eighteen)
        age_keyboard.row(back_button)

        await call.message.edit_text(text="""*First question*:
Please select your age.""", reply_markup=age_keyboard, parse_mode="Markdown")

    # –î–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–æ —Å—Ç–µ–∫—É
    stack.append(undersood_handler)

@dp.callback_query_handler(lambda call: call.data == 'less_than_eighteen')
async def less_than_eighteen(call: types.CallbackQuery):
    name = call.from_user.full_name
    user_id = call.from_user.id
    user_language = get_user_language(user_id)

    if user_language == "ua":
        school_life = types.InlineKeyboardButton(text="üì≤–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏", url="https://www.lifecell.ua/uk/mobilnij-zvyazok/taryfy/shkilniy/")
        not_interest = types.InlineKeyboardButton(text="‚ùå–ù–µ —Ü—ñ–∫–∞–≤–æ", callback_data="more_than_eighteen")
        back_button = types.InlineKeyboardButton(text="‚¨Ö –ù–∞–∑–∞–¥", callback_data="back")


        school_life_keyboard = types.InlineKeyboardMarkup()
        school_life_keyboard.row(school_life)
        school_life_keyboard.row(not_interest)
        school_life_keyboard.row(back_button)

        await call.message.edit_text(text=f"*{name}*, –º–∏ –ø–æ–º—ñ—Ç–∏–ª–∏, —â–æ –≤–∞–º –º–µ–Ω—à–µ 18-—Ç–∏. –¢–æ–º—É –ø—Ä–æ–ø–æ–Ω—É—î–º–æ –≤–∞–º —Ç–∞—Ä–∏—Ñ '*–®–∫—ñ–ª—å–Ω–∏–π –õ–∞–π—Ñ*', —è–∫–∏–π –∑—Ä–æ–±–ª–µ–Ω–∏–π —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ –¥–ª—è —à–∫–æ–ª—è—Ä—ñ–≤.", parse_mode="Markdown", reply_markup=school_life_keyboard)

    if user_language == "en":
            school_life = types.InlineKeyboardButton(text="üì≤Connect", url="https://www.lifecell.ua/uk/mobilnij-zvyazok/taryfy/shkilniy/")
            not_interest = types.InlineKeyboardButton(text="‚ùåNot interested", callback_data="more_than_eighteen")
            back_button = types.InlineKeyboardButton(text="‚¨Ö Back", callback_data="back")


            school_life_keyboard = types.InlineKeyboardMarkup()
            school_life_keyboard.row(school_life)
            school_life_keyboard.row(not_interest)
            school_life_keyboard.row(back_button)

            await call.message.edit_text(text=f"*{name}*, we noticed that you are under 18. That's why we offer you the '*School Life*' tariff, which is specially designed for schoolchildren.", parse_mode="Markdown", reply_markup=school_life_keyboard)

    stack.append(less_than_eighteen)


@dp.callback_query_handler(lambda call: call.data == 'more_than_eighteen')
async def more_than_eighteen(call: types.CallbackQuery):
    name = call.from_user.full_name
    user_id = call.from_user.id
    user_language = get_user_language(user_id)

    if user_language == "ua":
        own_button = types.InlineKeyboardButton(text="üôã‚Äç‚ôÇÔ∏è–î–ª—è —Å–µ–±–µ", callback_data="back")
        family_button = types.InlineKeyboardButton(text="üë®‚Äçüë©‚Äçüëß‚Äçüë¶–î–ª—è —Å—ñ–º'—ó", callback_data="back")
        for_gadget_button = types.InlineKeyboardButton(text="üíª–î–ª—è “ê–∞–¥–∂–µ—Ç–∞", callback_data="back")
        back_button = types.InlineKeyboardButton(text="‚¨Ö –ù–∞–∑–∞–¥", callback_data="back")

        usage_select = types.InlineKeyboardMarkup()
        usage_select.row(own_button)
        usage_select.row(family_button, for_gadget_button )
        usage_select.row(back_button)

        await call.message.edit_text(
            text=f"*{name}*, –¥–ª—è —è–∫–æ–≥–æ —Ç–∏–ø—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç–∞—Ä–∏—Ñ?", parse_mode="Markdown", reply_markup=usage_select)

    stack.append(more_than_eighteen)


@dp.callback_query_handler(lambda call: call.data == 'back')
async def back_handler(call: types.CallbackQuery):
    if len(stack) > 1:
        # –í–∏–¥–∞–ª—è—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –∑—ñ —Å—Ç–µ–∫—É
        stack.pop()
        # –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é —Ñ—É–Ω–∫—Ü—ñ—é –∑—ñ —Å—Ç–µ–∫—É
        previous_function = stack[-1]
        # –í–∏–∫–ª–∏–∫–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é —Ñ—É–Ω–∫—Ü—ñ—é
        await previous_function(call)
    else:
        # –Ø–∫—â–æ —Å—Ç–µ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π, –≤–∏–∫–æ–Ω—É—î–º–æ –¥—ñ—ó –¥–ª—è –≤–∏–ø–∞–¥–∫—É, –∫–æ–ª–∏ –Ω–µ–º–∞—î –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó
        await call.message.edit_reply_markup(reply_markup=None)

@dp.callback_query_handler()
async def language_callback(call: types.CallbackQuery):
    user_id = call.from_user.id
    language = call.data.split('_')[1]
    await bot.send_chat_action(user_id, 'typing')
    await asyncio.sleep(0.5)

    if language == "ua":
        await call.message.edit_text(text="""–í–∏ –æ–±—Ä–∞–ª–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—Éüá∫üá¶!
–í–∏ –∑–∞–≤–∂–¥–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –º–æ–≤—É –Ω–∞–ø–∏—Å–∞–≤—à–∏ /language
–¢–µ–ø–µ—Ä —â–µ —Ä–∞–∑ –Ω–∞–ø–∏—à—ñ—Ç—å /start!
""")
        save_language_choice(user_id, language)
        await start_taryf(call.message)


    elif language == "en":
        await call.message.edit_text(text="""You have successfully selected Englishüá¨üáß!
You can always change the language by writing /language
Now type /start again!
""")
        save_language_choice(user_id, language)


if __name__ == '__main__':
    from aiogram import executor

    executor.start_polling(dp, skip_updates=True)
